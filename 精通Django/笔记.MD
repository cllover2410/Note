# 入门



---
# 视图和URL配置


---
# Django模板


---
# 第4章 Django模型

## 4.5 基本的数据访问
### 4.5.1 添加模型的字符串表示形式 
- Django 自动提供了操作模型的高层 Python API。运行`python manage.py shell`
- `__str__()`方法的作用是告诉Python 如何以人类可读的形式显示对象`__str__()`方法的作用是告诉Python 如何以人类可读的形式显示对象。

### 4.5.2 插入和更新数据
- 将记录保存到数据库`save()`

### 4.5.3 选择对象
- 检索全部 `模型名.objects.all()`
- 访问objects属性。这叫管理器（manager），在第 9 章详述。现在，你只需知道，管理器负责所有“表层”数据操作，包括（最重要的）数据查询。所有模型都自动获得一个objects管理器，需要查询模型实例时都要使用它。

### 4.5.4 过滤数据
- 多数情况下，我们只想处理数据的子集。在 DjangoAPI 中，可以使用`filter()`方法过滤数据：
```python
Publisher.objects.filter(name='Apress')
[<Publisher:Apress>]
```
- 可以把*多个参数*传给`filter()`方法，进一步收窄要查询的数据:
```python
Publisher.objects.filter(country="U.S.A.",state_province="CA")
[<Publisher:Apress>]
```
- 特定查找，后面接双下划线
- 支持的其他查找类型有：contains，icontains（不区分大小写的LIKE），startswith和endswith，以及range（SQLBETWEEN语句）
```python
Publisher.objects.filter(name__contains="press")
[<Publisher:Apress>]
```

### 4.5.5 检索单个对象
获取单个对象。此时应该使用`get()`方法
```python
Publisher.objects.get(name="Apress")
<Publisher:Apress>
```

这个方法只返回一个对象，而不是一个列表（更确切地说是查询集合）。因此，得到多个对象的查询会导致异常,不返回对象的查询也导致异常。
DoesNotExist异常是模型类的属性——Publisher.DoesNotExist。在应用程序中可以像下面这样捕获这个异常：
```python
try:
    p = Publisher.objects.get(name='Apress')
except Publisher.DoesNotExist:
    print("Apress isn't in the database yet.")
else:
    print("Apress is in the database.")
```

### 4.5.6 排序数据
- 数据默认使用数据库选择的顺序排序。
- 按*字母表*顺序。为此，使用`order_by()`方法：
```python
Publisher.objects.order_by("name")
[<Publisher:Apress>,<Publisher:O'Reilly>]
```

- 可以根据任何字段排序：
```python
Publisher.objects.order_by("address")
[<Publisher:O'Reilly>, <Publisher: Apress>]

Publisher.objects.order_by("state_province")
[<Publisher: Apress>, <Publisher: O'Reilly>]
```

- 如果想根据多个字段排序（以第一个字段排不出顺序时使用第二个字段），提供多个参数：
```python
Publisher.objects.order_by("state_province","address")
[<Publisher:Apress>,<Publisher:O'Reilly>]
```

- 此外，还可以反向排序。方法是在字段名称前面加上“-”（减号）：
```python
Publisher.objects.order_by("-name")
[<Publisher:O'Reilly>, <Publisher: Apress>]
```

- 虽然order_by()有一定的灵活性，但是每次都调用它相当繁琐。多数时候，我们始终使用同一个字段排序。此时，可以在模型中指定默认排序：
```python
class Publisher(models.Model):
    name= models.CharField(max_length=30)
    address= models.CharField(max_length=50)
    city= models.CharField(max_length=60)
    state_province= models.CharField(max_length=30)
    country= models.CharField(max_length=50)
    website= models.URLField()
    
    def __str__(self):
        return self.name
    
    class Meta:
        ordering= ['name']
```
这里出现了一个新概念，内嵌在Publisher类定义体中的class Meta（即要缩进，放在class Publisher内部）。任何模型都可以使用Meta类指定多个针对所在模型的选项。全部可用的选项参见附录 B，现在我们关注的是排序选项。指定这个选项后，使用 Django 数据库 API 检索Publisher对象时，如果没有明确调用or-der_by()，都按照name字段排序


### 4.5.7 排序数据




### 4.5.8 切片数据
另一个常见的需求是只查找固定数量的行。假如数据库中有几千个出版社记录，但是只想显示第一个。为此，可以使用 Python 标准的列表切片句法：
```python
Publisher.objects.order_by('name')[0]<Publisher:Apress>
```

得到的 SQL 语句基本如下：
```sql
SELECTid,   name,address,city,state_province,country,websiteFROMbooks_publisherORDER BYnameLIMIT1;
```

类似地，可以使用 Python 的范围切片句法检索数据子集：
```
>>> Publisher.objects.order_by('name')[0:2]
```
这样得到的是两个对象，基本上相当于下述 SQL 语句：SELECTid,   name,address,city,state_province,country,websiteFROMbooks_publisherORDER BYnameOFFSET0 LIMIT2;

注意，不支持使用负数：
```
>>> Publisher.objects.order_by('name')[-1]Traceback(most recent call last):...AssertionError:Negative indexingis notsupported.
```

不过，这容易解决。只需修改order_by()语句，如下所示：
```python
Publisher.objects.order_by('-name')[0]
```



### 4.5.9 排序数据



### 4.5.10 删除数据
- 若想从数据库中删除一个对象，只需在对象上调用`delete()`方法：
```python
p = Publisher.objects.get(name="O'Reilly")
p.delete()
Publisher.objects.all()
[<Publisher:Apress Publishing>]
```

- 此外，还可以在任何QuerySet对象上调用delete()方法，批量删除对象。这与前一节所讲的update()方法类似。
```python
Publisher.objects.filter(country='USA').delete()
Publisher.objects.all().delete()
Publisher.objects.all()[]
```

- 删除数据要谨慎！为了防止不小心把表中的数据都删除，想删除表中的一切数据时，Django 要求必须显式调用all()方法。例如，下述代码无效：
```python
Publisher.objects.delete()
Traceback(most recent call last):
File"",   line1, in
AttributeError:'Manager'objecthas no attribute'delete'
```

- 添加all()方法后就可以了：
```python
Publisher.objects.all().delete()
```

- 如果只想删除部分数据，无需调用`all()`方法。
```python
Publisher.objects.filter(country='USA').delete()
```